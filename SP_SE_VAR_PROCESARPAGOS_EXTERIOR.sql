-- =====================================================================
-- PROCESAMIENTO OBLIGATORIO DEL ÚLTIMO GRUPO (el que quedó acumulado)
-- =====================================================================
CALL BLHSRVLIB.SP_SE_INS_PGLOGPROCESO(
    NUMIDUNICOFACTURA_ANT, 0, 0, 0, 0, 0,
    '=== FINAL DEL CICLO === Último grupo pendiente | ID: ' || NUMIDUNICOFACTURA_ANT ||
    ' | Monto acumulado: ' || DECMONTODEBITO ||
    ' | Facturas acumuladas: ' || INTCONTADORFACTOK ||
    ' | Cuenta pagador: ' || NUMCTAPAGADOR_ANT ||
    ' | Beneficiario: ' || NUMIDBENEFICIARIO_ANT
);

IF DECMONTODEBITO > 0 AND NUMFORMAPAGO_ANT = 3 AND NUMTIPO <> 2 THEN

    -- Preparar descripción con el contador acumulado
    SET VARDESCRIPCIONDEBITO = SUBSTRING(
        TRIM(VARNOMBREBENEFICIARIO) || ' ' || 
        CAST(INTCONTADORFACTOK AS VARCHAR(30)) || ' FACTURAS', 
        1, 30
    );

    CALL BLHSRVLIB.SP_SE_SEL_NOMBRECIFPAGADOR(
        NUMCIFPAGADOR, VARNOMBREPAGADOR, INTCODIGOERROR, VARMENSAJERESULTADO
    );
    IF INTCODIGOERROR <> 0 OR TRIM(VARNOMBREPAGADOR) = '' THEN
        SET VARNOMBREPAGADOR = 'PAGANET';
    END IF;

    SET VARDESCRIPCIONCREDITO = SUBSTRING(
        TRIM(VARNOMBREPAGADOR) || ' ' || 
        CAST(INTCONTADORFACTOK AS VARCHAR(30)) || ' FACTURAS', 
        1, 30
    );

    -- Cargar datos del beneficiario usando el ID de referencia del grupo (_ANT)
    SELECT 
        IDUNICOFACTURA, MONTOCOMISION, MONTOIMPUESTO, TASASEGURIDAD, DESCRIPCIONCREDITO,
        CORREOSACK1, CORREOSACK2, DIRECCIONBENEF, CIUDADBENEF, NOMBREBANCO,
        DIRECCIONBANCO, CIUDADBANCO, BENEFICIARIOTIPOBANCO, BENEFICIARIOBANCO,
        CIUDADBANCOINTERM, NOMBBANCOINTERM, DIRECBANCOINTERM, NUMCUENTABANCOINTERM,
        TIPOBANCOINTERM, BANCOINTERM, GASTOSCUENTA, GASTOSBANCOCORRESPONSAL,
        GLTRANSACCION, GLCOMISION, GLGASTOSCORRESPONSAL, CLIENTID
    INTO 
        CHRIDUNICOFACTURA, NUMMONTOCOMISION, NUMMONTOIMPUESTO, NUMTASASEGURIDAD, CHRDESCRIPCIONCREDITO,
        CHRCORREOSACK1, CHRCORREOSACK2, CHRDIRECCIONBENEF, CHRCIUDADBENEF, CHRNOMBREBANCO,
        CHRDIRECCIONBANCO, CHRCIUDADBANCO, CHRBENEFICIARIOTIPOBANCO, CHRBENEFICIARIOBANCO,
        CHRCIUDADBANCOINTERM, CHRNOMBBANCOINTERM, CHRDIRECBANCOINTERM, CHRNUMCUENTABANCOINTERM,
        CHRTIPOBANCOINTERM, CHRBANCOINTERM, CHRGASTOSCUENTA, NUMGASTOSBANCOCORRESPONSAL,
        CHRGLTRANSACCION, CHRGLCOMISION, CHRGLGASTOSCORRESPONSAL, NUMCLIENTID
    FROM BLHCYFILES.TB_SE_TRN_PGFACTURASEXTERIOR
    WHERE IDUNICOFACTURA = NUMIDUNICOFACTURA_ANT
    FETCH FIRST 1 ROW ONLY;

    -- Aquí continúa TODO el bloque de:
    -- - Obtener moneda cuenta pagador
    -- - Obtener teléfono y nombre ordenante
    -- - Centro de costo
    -- - Conversión códigos IC
    -- - Validación tipo banco corresponsal
    -- - Cálculo comisiones (site/global)
    -- - Cálculo gastos corresponsal
    -- - CALL SP_SE_VAR_TRANSFERENCIAEXTERIOR con DECMONTODEBITO acumulado
    -- - Manejo de resultado (SMS, commit/rollback, logs)

    -- (pega aquí exactamente el mismo código que ya tienes dentro del IF del loop,
    --  pero asegurándote de usar NUMIDUNICOFACTURA_ANT y DECMONTODEBITO acumulado)

    -- Ejemplo de llamada clave (usa monto acumulado):
    CALL BLHSRVLIB.SP_SE_VAR_TRANSFERENCIAEXTERIOR(
        NUMCIFPAGADOR, 
        NUMIDUNICOFACTURA_ANT, 
        NUMCTAPAGADOR_ANT, 
        CHRGLTRANSACCION, 
        CHRMONEDACUENTAPAGADOR,
        CHRCUENTABENEFICIARIO, 
        CHRMONEDACTABENEFICIARIO, 
        VARNOMBREBENEFICIARIO, 
        CHRDIRECCIONBENEF, 
        CHRCIUDADBENEF,
        CHRBENEFICIARIOTIPOBANCO, 
        CHRBENEFICIARIOBANCO, 
        CHRNOMBREBANCO, 
        CHRDIRECCIONBANCO, 
        CHRCIUDADBANCO,
        DECMONTODEBITO,          -- <--- ¡Importante! Usa el acumulado
        DECMONTODEBITO, 
        CHRDESCRIPCIONCREDITO, 
        CHRGASTOSCUENTA, 
        CHRNOMBREORDENANTE, 
        CHRDOCUMENTOIDENTIDADBENEFICIARIO, 
        DECTELEFONOPAGADOR, 
        CHRCORREOSACK1,
        CHRCORREOSACK2, 
        DECTCUSDCOMPRA, 
        DECTCUSDVENTA, 
        NUMGASTOSBANCOCORRESPONSAL, 
        NUMMONTOCOMISION, 
        NUMTASASEGURIDAD, 
        CHRTIPOBANCOINTERM,
        CHRBANCOINTERM, 
        CHRNOMBBANCOINTERM, 
        CHRDIRECBANCOINTERM, 
        CHRCIUDADBANCOINTERM, 
        CHRCIUDADBANCOINTERM,
        CHRNUMCUENTABANCOINTERM, 
        VARNUMEROREFERENCIA, 
        INTTIPORESULTADO, 
        VARMENSAJERESULTADO
    );

    -- Continúa con el manejo de resultado, SMS, commit/rollback, etc. (igual que dentro del loop)

END IF;

-- =====================================================================
-- LIMPIEZA FINAL Y ACTUALIZACIÓN DE ESTADOS RESTANTES
-- =====================================================================
UPDATE BLHCYFILES.TB_SE_TRN_PGTRANSACCIONESFACTURAS
SET ESTADOPROCESO = 0,
    ESTADOFACTURA = CASE 
        WHEN TIPOCANCELACION = 0 THEN 3
        WHEN TIPOCANCELACION = 2 THEN 7
        WHEN TIPOCANCELACION = 3 THEN 10
        WHEN TIPOCANCELACION = 4 THEN 11
        ELSE 3 
    END
WHERE ESTADOFACTURA = 4
  AND ESTADOPROCESO = INTESTADOPROCESO;

INSERT INTO BLHCYFILES.TB_SE_TRN_PGNOTIFICACIONES
SELECT * FROM SESSION.PGCOLANOTIFICACIONESTMP;

DELETE FROM SESSION.PGLOGPROCESOTMP;
DELETE FROM SESSION.PGCOLANOTIFICACIONESTMP;

CALL BLHSRVLIB.SP_SE_VAR_ENVIARCORREOSPAGANET();

COMMIT;